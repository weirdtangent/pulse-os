# V1.0 Test Coverage Roadmap

**Status**: In Progress
**Target**: 75% code coverage
**Current**: ~15-20% (168 tests, 1,200 test lines)
**Goal**: 500+ tests, 75%+ coverage

## Executive Summary

Pulse OS v0.101.7 is feature-complete and production-ready, but needs comprehensive test coverage before declaring v1.0. This document outlines the path from 15% to 75% coverage.

## Critical Path Items (Blockers for v1.0)

### 1. Version Metadata âœ… COMPLETE
- **Status**: Fixed in commit d9099c1
- **Change**: Updated `__version__` from 0.1.0 to 0.101.7
- **Impact**: Package metadata now matches release version

### 2. MQTT Client Tests (Priority: CRITICAL)
- **File**: `pulse/assistant/mqtt.py`
- **Current**: 0 dedicated tests
- **Target**: 20 tests, 80%+ coverage
- **Timeline**: Week 1

**Test Categories**:
- Connection lifecycle (connect, reconnect, disconnect)
- Message publishing (QoS 0, 1, 2)
- Message subscription and callbacks
- Error handling (network failures, broker unavailable)
- Will/LWT handling
- Topic filtering and wildcards
- Authentication (username/password, certificates)

**Why Critical**: MQTT is the nervous system of Pulse OS - all components communicate via MQTT.

### 3. Datetime Utilities Tests (Priority: HIGH)
- **File**: `pulse/datetime_utils.py`
- **Current**: 0 tests
- **Target**: 15 tests, 90%+ coverage
- **Timeline**: Week 1

**Test Categories**:
- Timezone handling (local, UTC, custom timezones)
- Recurring event parsing (RRULE, EXDATE)
- Next occurrence calculation
- DST transitions
- Edge cases (leap years, month boundaries)

**Why High Priority**: Schedule system relies heavily on datetime calculations.

### 4. Main Orchestration Tests (Priority: HIGH)
- **File**: `bin/pulse-assistant.py` (3,125 lines, 153 methods)
- **Current**: Limited indirect testing
- **Target**: 30 tests, 40%+ coverage
- **Timeline**: Weeks 2-3

**Test Categories**:
- Component initialization
- MQTT message routing
- LLM provider selection and fallback
- Error recovery and restart logic
- Configuration loading and validation
- State management
- Critical path: wake â†’ STT â†’ LLM â†’ TTS â†’ action

**Note**: This file is scheduled for refactoring into 12 modules. Tests should focus on high-level behavior that won't change during refactoring.

### 5. Kiosk MQTT Listener Tests (Priority: MEDIUM)
- **File**: `bin/kiosk-mqtt-listener.py` (2,088 lines)
- **Current**: 0 tests
- **Target**: 25 tests, 35%+ coverage
- **Timeline**: Week 3

**Test Categories**:
- Overlay state management
- Browser navigation commands
- Info card rendering triggers
- Schedule snapshot processing
- Font management
- Update mechanism

### 6. Integration Tests (Priority: CRITICAL)
- **Current**: 0 integration tests
- **Target**: 10 comprehensive pipeline tests
- **Timeline**: Week 3

**Test Scenarios**:
1. Full wake pipeline: wake word â†’ STT â†’ LLM â†’ TTS â†’ completion
2. Home Assistant integration: command â†’ HA service call â†’ state update
3. Calendar sync: fetch â†’ parse â†’ schedule update â†’ alarm trigger
4. MQTT telemetry: state change â†’ publish â†’ subscriber receive
5. Error recovery: LLM provider failure â†’ fallback â†’ retry â†’ success
6. Info card workflow: click badge â†’ MQTT publish â†’ overlay update
7. Timer lifecycle: create â†’ countdown â†’ expire â†’ notification
8. Multi-device coordination: alarm pause â†’ MQTT sync â†’ other devices update
9. Schedule conflict resolution: overlapping alarms â†’ priority handling
10. Network resilience: disconnect â†’ buffer â†’ reconnect â†’ replay

## Coverage Targets by Module

| Module                        | Current | Target | Priority | Tests Needed |
|-------------------------------|---------|--------|----------|--------------|
| pulse/assistant/mqtt.py       | 0%      | 80%    | CRITICAL | 20           |
| pulse/datetime_utils.py       | 0%      | 90%    | HIGH     | 15           |
| bin/pulse-assistant.py        | 5%      | 40%    | HIGH     | 30           |
| bin/kiosk-mqtt-listener.py    | 0%      | 35%    | MEDIUM   | 25           |
| Integration tests             | 0%      | N/A    | CRITICAL | 10           |
| **SUBTOTAL**                  |         |        |          | **100**      |

**Existing modules with good coverage** (maintain):
- pulse/assistant/home_assistant.py: 34 tests âœ“
- pulse/assistant/llm_providers/*.py: 27 tests âœ“
- pulse/config_persist.py: 25 tests âœ“
- pulse/overlay.py: 24 tests âœ“

**Total expected**: 168 (current) + 100 (new) = **268 tests**

## Testing Strategy

### Phase 1: Critical Infrastructure (Week 1)
1. MQTT client (20 tests)
2. Datetime utilities (15 tests)
3. Run coverage: `pytest --cov=pulse --cov-report=html tests/`
4. Target: 30% â†’ 40% coverage

### Phase 2: Main Components (Weeks 2-3)
1. Pulse assistant orchestration (30 tests)
2. Kiosk MQTT listener (25 tests)
3. Integration tests (10 tests)
4. Run coverage again
5. Target: 40% â†’ 60% coverage

### Phase 3: Gap Filling (Week 4)
1. Identify uncovered critical paths from coverage report
2. Add targeted tests for gaps
3. Focus on error handling branches
4. Target: 60% â†’ 75% coverage

### Phase 4: Maintenance
1. Set up coverage CI check (fail if <70%)
2. Require tests for all new code
3. Document testing standards

## Test Infrastructure Improvements

### Required Tools
- âœ… pytest-cov (added)
- âœ… pytest-asyncio (already present)
- Consider: pytest-mock, pytest-timeout

### CI/CD Integration
- Add coverage report to GitHub Actions
- Comment coverage % on PRs
- Fail builds if coverage drops below 70%
- Generate HTML coverage reports as artifacts

### Test Organization
```
tests/
â”œâ”€â”€ unit/              # Unit tests (fast, isolated)
â”‚   â”œâ”€â”€ test_mqtt_client.py
â”‚   â”œâ”€â”€ test_datetime_utils.py
â”‚   â””â”€â”€ test_*.py
â”œâ”€â”€ integration/       # Integration tests (slower)
â”‚   â”œâ”€â”€ test_wake_pipeline.py
â”‚   â”œâ”€â”€ test_ha_integration.py
â”‚   â””â”€â”€ test_*.py
â””â”€â”€ fixtures/          # Shared test fixtures
    â”œâ”€â”€ mqtt.py
    â”œâ”€â”€ llm_mocks.py
    â””â”€â”€ ha_mocks.py
```

## Coverage Reporting

### Run Coverage Locally
```bash
# Full coverage report
pytest --cov=pulse --cov=bin --cov-report=html --cov-report=term tests/

# View HTML report
open htmlcov/index.html

# Focus on specific module
pytest --cov=pulse/assistant/mqtt --cov-report=term tests/test_mqtt_client.py
```

### Coverage Metrics to Track
- **Line coverage**: % of lines executed
- **Branch coverage**: % of if/else branches taken
- **Function coverage**: % of functions called
- **Missing lines**: Identify untested code

### Coverage Goals by Type
- **Critical paths**: 90%+ (MQTT, datetime, orchestration)
- **UI/overlay**: 70%+ (harder to test, but still important)
- **Utilities**: 85%+ (should be easy to test)
- **Integration**: 100% of happy paths, 80% of error paths

## Success Criteria for v1.0

âœ… **MUST HAVE**:
1. Version metadata matches release (v0.101.7) âœ… DONE
2. MQTT client: 80%+ coverage, 20+ tests
3. Datetime utils: 90%+ coverage, 15+ tests
4. Integration tests: 10+ end-to-end scenarios
5. Overall coverage: 75%+
6. All existing tests pass (168/168)
7. Coverage CI check enabled

ðŸŽ¯ **SHOULD HAVE**:
1. Main orchestration: 40%+ coverage, 30+ tests
2. Kiosk listener: 35%+ coverage, 25+ tests
3. Coverage report in CI artifacts
4. Test documentation (how to run, how to write)

ðŸ’¡ **NICE TO HAVE**:
1. Performance benchmarks
2. Load testing (100+ MQTT messages/sec)
3. Memory profiling
4. Mutation testing (test quality metrics)

## Timeline

| Week | Focus Area                          | Tests Added | Coverage Target |
|------|-------------------------------------|-------------|-----------------|
| 1    | MQTT + datetime + setup             | 35          | 40%             |
| 2    | Orchestration + partial integration | 30          | 55%             |
| 3    | Kiosk + remaining integration       | 35          | 70%             |
| 4    | Gap filling + polish                | 20-30       | 75%+            |

**Total duration**: 4 weeks
**Expected outcome**: v1.0-ready codebase with comprehensive tests

## Post-v1.0 Improvements

After v1.0 release, continue improving:
- **80% coverage** by v1.1
- **90% coverage** by v1.2
- **Mutation testing** to verify test quality
- **Property-based testing** for edge cases
- **Fuzz testing** for parser robustness

## Notes

- Focus on testing **behavior**, not implementation
- Write tests that survive refactoring (test public APIs)
- Mock external services (LLM, HA, MQTT broker)
- Use fixtures for common setup
- Keep tests fast (<1s each for unit tests)
- Integration tests can be slower but should complete in <30s
- Document why tests exist (purpose, not just what they do)

---

**Document Version**: 1.0
**Last Updated**: 2026-01-08
**Owner**: @weirdtangent
**Status**: Active Development

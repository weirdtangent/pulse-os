name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
  actions: read

jobs:
  claude:
    # TODO: Remove continue-on-error once upstream SDK bugs are fixed
    # See: https://github.com/anthropics/claude-code-action/issues/892
    continue-on-error: true
    if: >
      github.actor != 'dependabot[bot]' && (
        github.event_name == 'pull_request' ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
      )
    runs-on: ubuntu-latest
    concurrency:
      group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Dismiss and minimize prior Claude reviews
        if: github.event_name == 'pull_request' && github.event.action != 'opened'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          PR=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          # Resolve the bot login for the GitHub App that generated our token
          APP_SLUG=$(gh api /app --jq '.slug')
          BOT_LOGIN="${APP_SLUG}[bot]"
          echo "Cleaning up prior reviews from ${BOT_LOGIN}"

          # Dismiss APPROVED and CHANGES_REQUESTED reviews from our bot
          gh api "repos/${REPO}/pulls/${PR}/reviews" --paginate --jq \
            --arg login "$BOT_LOGIN" \
            '.[] | select(.user.login == $login and (.state == "APPROVED" or .state == "CHANGES_REQUESTED")) | .id' | \
          while read -r REVIEW_ID; do
            gh api --method PUT "repos/${REPO}/pulls/${PR}/reviews/${REVIEW_ID}/dismissals" \
              -f message="Superseded by new code changes" \
              || echo "Warning: Failed to dismiss review ${REVIEW_ID}"
          done

          # Minimize bot review comments (inline code comments) as OUTDATED
          gh api "repos/${REPO}/pulls/${PR}/comments" --paginate --jq \
            --arg login "$BOT_LOGIN" \
            '.[] | select(.user.login == $login) | .node_id' | \
          while read -r NODE_ID; do
            gh api graphql -f query='
              mutation($id: ID!) {
                minimizeComment(input: {subjectId: $id, classifier: OUTDATED}) {
                  minimizedComment { isMinimized }
                }
              }' -f id="$NODE_ID" \
              || echo "Warning: Failed to minimize review comment ${NODE_ID}"
          done

          # Minimize bot issue comments (top-level PR discussion comments) as OUTDATED
          gh api "repos/${REPO}/issues/${PR}/comments" --paginate --jq \
            --arg login "$BOT_LOGIN" \
            '.[] | select(.user.login == $login) | .node_id' | \
          while read -r NODE_ID; do
            gh api graphql -f query='
              mutation($id: ID!) {
                minimizeComment(input: {subjectId: $id, classifier: OUTDATED}) {
                  minimizedComment { isMinimized }
                }
              }' -f id="$NODE_ID" \
              || echo "Warning: Failed to minimize issue comment ${NODE_ID}"
          done

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ steps.app-token.outputs.token }}
          model: claude-opus-4-5-20251101
          claude_args: |
            --allowedTools "Bash(gh:*)"
          prompt: |
            Review this pull request for code quality, security issues,
            potential bugs, and best practices. If everything looks good,
            approve the PR. If you find any issues, leave review comments.
